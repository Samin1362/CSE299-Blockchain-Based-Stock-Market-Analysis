from web3 import Web3, EthereumTesterProvider
from solcx import compile_standard
import json
import os


bytecode = '60806040526001600255600160035534801561001a57600080fd5b50611a638061002a6000396000f3fe60806040526004361061009c5760003560e01c8063a87430ba11610064578063a87430ba14610189578063b7013dc1146101c8578063b9303dbd146101f3578063da52c6ff1461020f578063e2f616c014610238578063eaaa9113146102615761009c565b8063226b876c146100a157806351c181a3146100e1578063704f1b941461010a5780639cfe764614610133578063a1e6a2551461015e575b600080fd5b3480156100ad57600080fd5b506100c860048036038101906100c39190611157565b61029e565b6040516100d89493929190611671565b60405180910390f35b3480156100ed57600080fd5b5061010860048036038101906101039190611180565b610356565b005b34801561011657600080fd5b50610131600480360381019061012c91906110af565b61053f565b005b34801561013f57600080fd5b5061014861063c565b6040516101559190611618565b60405180910390f35b34801561016a57600080fd5b50610173610642565b6040516101809190611618565b60405180910390f35b34801561019557600080fd5b506101b060048036038101906101ab919061104a565b610648565b6040516101bf93929190611633565b60405180910390f35b3480156101d457600080fd5b506101dd6106fa565b6040516101ea9190611618565b60405180910390f35b61020d60048036038101906102089190611180565b610743565b005b34801561021b57600080fd5b50610236600480360381019061023191906110f0565b610974565b005b34801561024457600080fd5b5061025f600480360381019061025a9190611073565b610a46565b005b34801561026d57600080fd5b506102886004803603810190610283919061104a565b610b10565b6040516102959190611556565b60405180910390f35b60016020528060005260406000206000915090508060000154908060010180546102c7906118e6565b80601f01602080910402602001604051908101604052809291908181526020018280546102f3906118e6565b80156103405780601f1061031557610100808354040283529160200191610340565b820191906000526020600020905b81548152906001019060200180831161032357829003601f168201915b5050505050908060020154908060030154905084565b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030160008481526020019081526020016000205410156103eb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103e2906115b8565b60405180910390fd5b600081600160008581526020019081526020016000206002015461040f91906117da565b9050806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160008282546104629190611784565b92505081905550816000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301600085815260200190815260200160002060008282546104cb9190611834565b92505081905550816001600085815260200190815260200160002060030160008282546104f89190611784565b925050819055507fbd1db00cf06624cfef55f2f2a900b91cfbd7c8b4ab84761f6b3cdfa0c88cc2f63384846040516105329392919061151f565b60405180910390a1505050565b6000815111610583576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161057a90611578565b60405180910390fd5b6003546000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000181905550806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001019080519060200190610620929190610eed565b506003600081548092919061063490611918565b919050555050565b60025481565b60035481565b6000602052806000526040600020600091509050806000015490806001018054610671906118e6565b80601f016020809104026020016040519081016040528092919081815260200182805461069d906118e6565b80156106ea5780601f106106bf576101008083540402835291602001916106ea565b820191906000526020600020905b8154815290600101906020018083116106cd57829003601f168201915b5050505050908060020154905083565b60008060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020154905090565b806001600084815260200190815260200160002060030154101561079c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610793906115f8565b60405180910390fd5b60008160016000858152602001908152602001600020600201546107c091906117da565b9050806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600201541015610846576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161083d906115d8565b60405180910390fd5b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160008282546108979190611834565b92505081905550816000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301600085815260200190815260200160002060008282546109009190611784565b925050819055508160016000858152602001908152602001600020600301600082825461092d9190611834565b925050819055507f1560b71ca6695825842f12e8721dc7f437286c08deb7c7ebc708bb3bdc3d01c53384846040516109679392919061151f565b60405180910390a1505050565b60405180608001604052806002548152602001848152602001838152602001828152506001600060025481526020019081526020016000206000820151816000015560208201518160010190805190602001906109d2929190610eed565b5060408201518160020155606082015181600301559050507f537bf2f604e15ea95351be3a847a86deebe61cdfc21ea93660a2768ccbdd1dc4600254848484604051610a219493929190611671565b60405180910390a160026000815480929190610a3c90611918565b9190505550505050565b8173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610ab4576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610aab90611598565b60405180910390fd5b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206002016000828254610b059190611784565b925050819055505050565b606060006001600254610b239190611834565b67ffffffffffffffff811115610b62577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015610b905781602001602082028036833780820191505090505b509050600080600190505b600254811015610c685760008060008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003016000838152602001908152602001600020541115610c555780838381518110610c3a577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010181815250508180610c5190611918565b9250505b8080610c6090611918565b915050610b9b565b5060008167ffffffffffffffff811115610cab577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015610ce457816020015b610cd1610f73565b815260200190600190039081610cc95790505b50905060005b82811015610ee1576000848281518110610d2d577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151905060006001600083815260200190815260200160002060405180608001604052908160008201548152602001600182018054610d71906118e6565b80601f0160208091040260200160405190810160405280929190818152602001828054610d9d906118e6565b8015610dea5780601f10610dbf57610100808354040283529160200191610dea565b820191906000526020600020905b815481529060010190602001808311610dcd57829003601f168201915b5050505050815260200160028201548152602001600382015481525050905060405180608001604052808260000151815260200182602001518152602001826040015181526020016000808b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301600085815260200190815260200160002054815250848481518110610ec1577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001018190525050508080610ed990611918565b915050610cea565b50809350505050919050565b828054610ef9906118e6565b90600052602060002090601f016020900481019282610f1b5760008555610f62565b82601f10610f3457805160ff1916838001178555610f62565b82800160010185558215610f62579182015b82811115610f61578251825591602001919060010190610f46565b5b509050610f6f9190610f9b565b5090565b6040518060800160405280600081526020016060815260200160008152602001600081525090565b5b80821115610fb4576000816000905550600101610f9c565b5090565b6000610fcb610fc6846116ee565b6116bd565b905082815260208101848484011115610fe357600080fd5b610fee8482856118a4565b509392505050565b600081359050611005816119ff565b92915050565b600082601f83011261101c57600080fd5b813561102c848260208601610fb8565b91505092915050565b60008135905061104481611a16565b92915050565b60006020828403121561105c57600080fd5b600061106a84828501610ff6565b91505092915050565b6000806040838503121561108657600080fd5b600061109485828601610ff6565b92505060206110a585828601611035565b9150509250929050565b6000602082840312156110c157600080fd5b600082013567ffffffffffffffff8111156110db57600080fd5b6110e78482850161100b565b91505092915050565b60008060006060848603121561110557600080fd5b600084013567ffffffffffffffff81111561111f57600080fd5b61112b8682870161100b565b935050602061113c86828701611035565b925050604061114d86828701611035565b9150509250925092565b60006020828403121561116957600080fd5b600061117784828501611035565b91505092915050565b6000806040838503121561119357600080fd5b60006111a185828601611035565b92505060206111b285828601611035565b9150509250929050565b60006111c8838361149e565b905092915050565b6111d981611868565b82525050565b60006111ea8261172e565b6111f48185611751565b9350836020820285016112068561171e565b8060005b85811015611242578484038952815161122385826111bc565b945061122e83611744565b925060208a0199505060018101905061120a565b50829750879550505050505092915050565b600061125f82611739565b6112698185611762565b93506112798185602086016118b3565b611282816119ee565b840191505092915050565b600061129882611739565b6112a28185611773565b93506112b28185602086016118b3565b6112bb816119ee565b840191505092915050565b60006112d3601483611773565b91507f4e616d652063616e6e6f7420626520656d7074790000000000000000000000006000830152602082019050919050565b6000611313602883611773565b91507f4f6e6c792074686520757365722063616e20696e63726561736520746865697260008301527f2062616c616e63650000000000000000000000000000000000000000000000006020830152604082019050919050565b6000611379602383611773565b91507f496e73756666696369656e742073746f636b207175616e7469747920746f207360008301527f656c6c00000000000000000000000000000000000000000000000000000000006020830152604082019050919050565b60006113df602183611773565b91507f496e73756666696369656e742062616c616e636520746f206275792073746f6360008301527f6b000000000000000000000000000000000000000000000000000000000000006020830152604082019050919050565b6000611445602a83611773565b91507f4e6f7420656e6f75676820617661696c61626c652073746f636b207175616e7460008301527f69747920746f20627579000000000000000000000000000000000000000000006020830152604082019050919050565b60006080830160008301516114b66000860182611501565b50602083015184820360208601526114ce8282611254565b91505060408301516114e36040860182611501565b5060608301516114f66060860182611501565b508091505092915050565b61150a8161189a565b82525050565b6115198161189a565b82525050565b600060608201905061153460008301866111d0565b6115416020830185611510565b61154e6040830184611510565b949350505050565b6000602082019050818103600083015261157081846111df565b905092915050565b60006020820190508181036000830152611591816112c6565b9050919050565b600060208201905081810360008301526115b181611306565b9050919050565b600060208201905081810360008301526115d18161136c565b9050919050565b600060208201905081810360008301526115f1816113d2565b9050919050565b6000602082019050818103600083015261161181611438565b9050919050565b600060208201905061162d6000830184611510565b92915050565b60006060820190506116486000830186611510565b818103602083015261165a818561128d565b90506116696040830184611510565b949350505050565b60006080820190506116866000830187611510565b8181036020830152611698818661128d565b90506116a76040830185611510565b6116b46060830184611510565b95945050505050565b6000604051905081810181811067ffffffffffffffff821117156116e4576116e36119bf565b5b8060405250919050565b600067ffffffffffffffff821115611709576117086119bf565b5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600061178f8261189a565b915061179a8361189a565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156117cf576117ce611961565b5b828201905092915050565b60006117e58261189a565b91506117f08361189a565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048311821515161561182957611828611961565b5b828202905092915050565b600061183f8261189a565b915061184a8361189a565b92508282101561185d5761185c611961565b5b828203905092915050565b60006118738261187a565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b82818337600083830152505050565b60005b838110156118d15780820151818401526020810190506118b6565b838111156118e0576000848401525b50505050565b600060028204905060018216806118fe57607f821691505b6020821081141561191257611911611990565b5b50919050565b60006119238261189a565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82141561195657611955611961565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b611a0881611868565b8114611a1357600080fd5b50565b611a1f8161189a565b8114611a2a57600080fd5b5056fea26469706673582212207fedcadb4b2fb6a7fff16a8512084eab7da62e389de2177168e0336b2b40d92f64736f6c63430008000033'
abi = json.loads('[{"inputs":[{"internalType":"string","name":"_name","type":"string"},{"internalType":"uint256","name":"_price","type":"uint256"},{"internalType":"uint256","name":"_availableQuantity","type":"uint256"}],"name":"addStock","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_stockId","type":"uint256"},{"internalType":"uint256","name":"_quantity","type":"uint256"}],"name":"buyStock","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"increaseUserBalance","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_name","type":"string"}],"name":"registerUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_stockId","type":"uint256"},{"internalType":"uint256","name":"_quantity","type":"uint256"}],"name":"sellStock","outputs":[],"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"string","name":"name","type":"string"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"availableQuantity","type":"uint256"}],"name":"StockAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"stockId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"StockBought","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"uint256","name":"stockId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"StockSold","type":"event"},{"inputs":[{"internalType":"address","name":"userAddress","type":"address"}],"name":"getStocksOwnedDetails","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"uint256","name":"quantity","type":"uint256"}],"internalType":"struct DSE.StockDetails[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getUserBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextStockId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextUserId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"stocks","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"uint256","name":"availableQuantity","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"}]')
    
w3 = Web3(Web3.HTTPProvider("HTTP://127.0.0.1:7545"))
chain_id = 1337
my_address = "0x3bA90Ab143AF1Eb961fAF902b9B53Cab2d812368"
private_key = "0xcdec6515dcd5433574011b5625dffbc894847236599f7e7d4d9182d35783ab62"

DSE = w3.eth.contract(abi=abi, bytecode=bytecode)


nonce = w3.eth.get_transaction_count(my_address)

transaction = DSE.constructor().build_transaction(
    {
        "chainId":chain_id, 
        "gasPrice": w3.eth.gas_price,
        "from":my_address, 
        "nonce":nonce
    }
)

signed_txn = w3.eth.account.sign_transaction(transaction, private_key=private_key)

#Send this signed transaction
tx_hash = w3.eth.send_raw_transaction(signed_txn.rawTransaction)
tx_receipt = w3.eth.wait_for_transaction_receipt(tx_hash)

dse = w3.eth.contract(address=tx_receipt.contractAddress, abi=abi)

#For first stock
store_transaction = dse.functions.addStock("IFIC", 20, 100).build_transaction(
    {
        "chainId":chain_id,
        "gasPrice":w3.eth.gas_price,
        "from":my_address,
        "nonce":nonce+1,
    }
)
sign_store_transaction = w3.eth.account.sign_transaction(store_transaction, private_key=private_key)
send_transaction = w3.eth.send_raw_transaction(sign_store_transaction.rawTransaction)
transaction_receipt = w3.eth.wait_for_transaction_receipt(send_transaction)

#For second stock
store_transaction = dse.functions.addStock("ICC", 10, 200).build_transaction(
    {
        "chainId":chain_id,
        "gasPrice":w3.eth.gas_price,
        "from":my_address,
        "nonce":nonce+2,
    }
)
sign_store_transaction = w3.eth.account.sign_transaction(store_transaction, private_key=private_key)
send_transaction = w3.eth.send_raw_transaction(sign_store_transaction.rawTransaction)
transaction_receipt = w3.eth.wait_for_transaction_receipt(send_transaction)

# #For third stock
store_transaction = dse.functions.addStock("WWE", 20, 300).build_transaction(
    {
        "chainId":chain_id,
        "gasPrice":w3.eth.gas_price,
        "from":my_address,
        "nonce":nonce+3,
    }
)
sign_store_transaction = w3.eth.account.sign_transaction(store_transaction, private_key=private_key)
send_transaction = w3.eth.send_raw_transaction(sign_store_transaction.rawTransaction)
transaction_receipt = w3.eth.wait_for_transaction_receipt(send_transaction)


#For Fourth stock
store_transaction = dse.functions.addStock("UFC", 15, 150).build_transaction(
    {
        "chainId":chain_id,
        "gasPrice":w3.eth.gas_price,
        "from":my_address,
        "nonce":nonce+4,
    }
)
sign_store_transaction = w3.eth.account.sign_transaction(store_transaction, private_key=private_key)
send_transaction = w3.eth.send_raw_transaction(sign_store_transaction.rawTransaction)
transaction_receipt = w3.eth.wait_for_transaction_receipt(send_transaction)
    
store_transaction = dse.functions.increaseUserBalance(my_address, 1000).build_transaction(
    {
         "chainId":chain_id,
        "gasPrice":w3.eth.gas_price,
        "from":my_address,
        "nonce":nonce+5,
    }
)
sign_store_transaction = w3.eth.account.sign_transaction(store_transaction, private_key=private_key)
send_transaction = w3.eth.send_raw_transaction(sign_store_transaction.rawTransaction)
transaction_receipt = w3.eth.wait_for_transaction_receipt(send_transaction)



